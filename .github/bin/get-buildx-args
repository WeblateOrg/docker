#!/bin/sh

# Generate command line options for docker buildx build

# Load from local cache
echo --cache-from "type=local,src=/tmp/.buildx-cache"

# Write to local cache unless publishing (not compatible with push)
if [ "$1" != "publish" ] ; then
    echo --cache-to "type=local,dest=/tmp/.buildx-cache"
fi

if [ "$1" = "load" ] ; then
    # Ommit list of platforms loading, see https://github.com/docker/buildx/issues/59
    echo --output=type=docker
    # Test tag, to avoid collistion with real ones
    echo --tag weblate/weblate:test
else
    # List of platforms
    echo --platform ${MATRIX_ARCHITECTURE:-linux/amd64,linux/arm/v7,linux/arm64}
    # Enable more platforms in future:
    # linux/amd64,linux/arm/v6,linux/arm/v7,linux/arm64,linux/386,linux/ppc64le,linux/s390x

    if [ "$1" = "publish-bleeding" ] ; then
        # Publishing bleeding edge image
        echo --output "type=image,push=true"
        echo --tag weblate/weblate:bleeding
    elif [ "$1" = "publish" ] ; then
        # Publishing normal image
        echo --output "type=image,push=true"

        # Generate tags
        case $GITHUB_REF in
            refs/tags/[0-9]*)
                echo --tag weblate/weblate:${GITHUB_REF#refs/tags/}
                echo --tag weblate/weblate:latest
                ;;
            refs/heads/master)
                echo --tag weblate/weblate:edge
                ;;
        esac
    else
        echo --output "type=image,push=false"
    fi
fi

# Location
echo --file ./Dockerfile .
